
nref  = 1;         % n?de referência
vref  = 1.0;        % tensão na subestação (pu)
vbase = 11.0;      % Tensão base (kV)
sbase = 10000;      % Potência base (kVA)
tol   = 10^-8;      % Tolerância do erro permitida
vmin  = 0.90;       % Tensão mínima (pu)
vmax  = 1.00;       % Tensão máxima (pu)

% Base de impedância
% Basis of impedance
zbase = 1000*((vbase^2)/sbase);

%%
%from to R(ohm) X(ohm)
Branch = [
1	2	0.036	0.01296 % 1
2	3	0.033	0.01188
2	4	0.045	0.0162
4	5	0.015	0.054
5	6	0.015	0.054
6	7	0.015	0.0125
7	8	0.018	0.014
8	9	0.021	0.063
2	10	0.166	0.1344
10	11	0.112	0.0789
11	12	0.187	0.313
12	13	0.142	0.1512
13	14	0.18	0.118
14	15	0.15	0.045
15	16	0.16	0.18
16	17	0.157	0.171
11	18	0.218	0.285
18	19	0.118	0.185
19	20	0.16	0.196
20	21	0.12	0.189
21	22	0.12	0.0789
22	23	1.41	0.723
23	24	0.293	0.1348
24	25	0.133	0.104
25	26	0.178	0.134
26	27	0.178	0.134
4	29	0.015	0.0296
29	30	0.012	0.0276
30	31	0.12	0.2766
31	32	0.21	0.243
32	33	0.12	0.054
33	34	0.178	0.234
34	35	0.178	0.234
35	36	0.154	0.162
31	37	0.187	0.261
37	38	0.133	0.099
30	40	0.33	0.194
40	41	0.31	0.194
41	42	0.13	0.194
42	43	0.28	0.15
43	44	1.18	0.85
44	45	0.42	0.2436
45	46	0.27	0.0972
46	47	0.339	0.1221
47	48	0.27	0.1779
36	49	0.21	0.1383
49	50	0.12	0.0789
50	51	0.15	0.0987
51	52	0.15	0.0987
52	53	0.24	0.1581
53	54	0.12	0.0789
54	55	0.405	0.1458
% 55	56	0.405	0.1458 % 55-56?
54	56	0.405	0.1458 % 55-56?
30	58	0.391	0.141
58	59	0.406	0.1461
59	60	0.406	0.1461
60	61	0.706	0.5461
61	62	0.338	0.1218
62	63	0.338	0.1218
63	64	0.207	0.0747
64	65	0.247	0.8922
1	66	0.028	0.0418
66	67	0.117	0.2016
67	68	0.255	0.0918
68	69	0.21	0.0759
69	70	0.383	0.138
70	71	0.504	0.3303
71	72	0.406	0.1461
72	73	0.962	0.761
73	74	0.165	0.06
74	75	0.303	0.1092
75	76	0.303	0.1092
76	77	0.206	0.144
77	78	0.233	0.084
78	79	0.591	0.1773
79	80	0.126	0.0453
67	81	0.559	0.3687
81	82	0.186	0.1227
82	83	0.186	0.1227
83	84	0.26	0.139
84	85	0.154	0.148
85	86	0.23	0.128
86	87	0.252	0.106
87	88	0.18	0.148
82	89	0.16	0.182
89	90	0.2	0.23
90	91	0.16	0.393
68	93	0.669	0.2412
93	94	0.266	0.1227
94	95	0.266	0.1227
95	96	0.266	0.1227
96	97	0.266	0.1227
97	98	0.233	0.115
98	99	0.496	0.138
95	100	0.196	0.18
100	101	0.196	0.18
101	102	0.1866	0.122
102	103	0.0746	0.318
1	105	0.0625	0.0265
105	106	0.1501	0.234
106	107	0.1347	0.0888
107	108	0.2307	0.1203
108	109	0.447	0.1608
109	110	0.1632	0.0588
110	111	0.33	0.099
111	112	0.156	0.0561
112	113	0.3819	0.1374
113	114	0.1626	0.0585
114	115	0.3819	0.1374
115	116	0.2445	0.0879
115	117	0.2088	0.0753
117	118	0.2301	0.0828
105	119	0.6102	0.2196
119	120	0.1866	0.127   % 114
120	121	0.3732	0.246
121	122	0.405	0.367
122	123	0.489	0.438
48	27	0.5258	0.2925 % 118  tie lines from here on
17	27	0.5258	0.2916
8	24	0.4272	0.1539
56	45	0.48	0.1728
65	56	0.36	0.1296 % 65-51 ?
38	65	0.57	0.572
9	42	0.53	0.3348
61	100	0.3957	0.1425
76	95	0.68	0.648
91	78	0.4062	0.1464
103	80	0.4626	0.1674
113	86	0.651	0.234
110	89	0.8125	0.2925
115	123	0.7089	0.2553 % 131
25	36	0.5	0.5  ];    % 132

%%
% bus Pd(kW) Qd(kW) Qbc(kW)
Bus = [
1	0	0
2	133.84	101.14
3	16.214	11.292
4	34.315	21.845
5	73.016	63.602
6	144.2	68.604
7	104.47	61.725
8	28.547	11.503
9	87.56	51.073
10	198.2	106.77
11	146.8	75.995
12	26.04	18.687
13	52.1	23.22
14	141.9	117.5
15	21.87	28.79
16	33.37	26.45
17	32.43	25.23
18	20.234	11.906
19	156.94	78.523
20	546.29	351.4
21	180.31	164.2
22	93.167	54.594
23	85.18	39.65
24	168.1	95.178
25	125.11	150.22
26	16.03	24.62
27	26.03	24.62
29	594.56	522.62
30	120.62	59.117
31	102.38	99.554
32	513.4	318.5
33	475.25	456.14
34	151.43	136.79
35	205.38	83.302
36	131.6	93.082
37	448.4	369.79
38	440.52	321.64
40	112.54	55.134
41	53.963	38.998
42	393.05	342.6
43	326.74	278.56
44	536.26	240.24
45	76.247	66.562
46	53.52	39.76
47	40.328	31.964
48	39.653	20.758
49	66.195	42.361
50	73.904	51.653
51	114.77	57.965
52	918.37	1205.1
53	210.3	146.66
54	66.68	56.608
55	42.207	40.184
56	433.74	283.41
58	62.1	26.86
59	92.46	88.38
60	85.188	55.436
61	345.3	332.4
62	22.5	16.83
63	80.551	49.156
64	95.86	90.758
65	62.92	47.7
66	478.8	463.74
67	120.94	52.006
68	139.11	100.34
69	391.78	193.5
70	27.741	26.713
71	52.814	25.257
72	66.89	38.713
73	467.5	395.14
74	594.85	239.74
75	132.5	84.363
76	52.699	22.482
77	869.79	614.775
78	31.349	29.817
79	192.39	122.43
80	65.75	45.37
81	238.15	223.22
82	294.55	162.47
83	485.57	437.92
84	243.53	183.03
85	243.53	183.03
86	134.25	119.29
87	22.71	27.96
88	49.513	26.515
89	383.78	257.16
90	49.64	20.6
91	22.473	11.806
93	62.93	42.96
94	30.67	34.93
95	62.53	66.79
96	114.57	81.748
97	81.292	66.526
98	31.733	15.96
99	33.32	60.48
100	531.28	224.85
101	507.03	367.42
102	26.39	11.7
103	45.99	30.392
105	100.66	47.572
106	456.48	350.3
107	522.56	449.29
108	408.43	168.46
109	141.48	134.25
110	104.43	66.024
111	96.793	83.647
112	493.92	419.34
113	225.38	135.88
114	509.21	387.21
115	188.5	173.46
116	918.03	898.55
117	305.08	215.37
118	54.38	40.97
119	211.14	192.9
120	67.009	53.336
121	162.07	90.321
122	48.785	29.156
123	33.9	18.98
];

Branch_org = Branch;
Bus_org = Bus;

%% zjp 2018-1-23
branch_always_on = [
2 3
54 55
95 96
96 97
97 98
98 99
86 87
87 88
115 116
115 117
117 118
];

[idx_ext_int, Bus, Branch, branch_always_on] = ...
    my_ext2int(Bus, Branch, branch_always_on);


branches_not_in_loop = branch_always_on;
    idx_not_in_loop = [];
    for i = 1:size(branches_not_in_loop, 1)     
        idx_brch0 = find_branch(Branch, branches_not_in_loop(i,1), ...
            branches_not_in_loop(i,2));
        if idx_brch0
            idx_not_in_loop = [idx_not_in_loop; idx_brch0];  
        else
            i, branches_not_in_loop(i, :)
            fprintf('error at line 1083 of d119_v2.m')
            error
        end
    end  
    idx_all = [1:size(Branch,1)];
    brch_idx_in_loop = idx_all;
    brch_idx_in_loop(idx_not_in_loop) = [];
    