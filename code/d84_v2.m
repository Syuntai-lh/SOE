%%
if casei == 1
    % case1,  for  increment_reconfig.m
    loop_type = 1;
    saved_node = [84 1 2 3 4 5 47 48 49 50 51 52 53 54 55]; % open the 53-54, correct
    deleted_node = [1:84];
    deleted_node(saved_node) = [];
    loopi{1} = [];
elseif casei == 2
    % case2,  for decrease_reconfig.m
    loop_type = 1;
    saved_node = [84 56 57 58 59 60 61 62 63 64 7 8 9 10  53 52 51 50 49 48 47 ...
        54 55 6 5 4 3 2 1];
    deleted_node = [1:84];
    deleted_node(saved_node) = [];
    loopi{1} = [84 47 48 49 50 51 52 53 54 55 5 4 3 2 1 84]
    loopi{2} = [84 56 57 58 59 60 7 6 5]
    loopi{3} = [60 61 62 63 64 53 54 55 5 6 7 60]
elseif casei == 3
    % case3,  for decrease_reconfig.m
    loop_type = 1;
    saved_node = [84 56 57 58 59 60 61  7 8 9 10  53 52 51 50 49 48 47 ...
        54 55 6 5 4 3 2 1];
    deleted_node = [1:84];
    deleted_node(saved_node) = [];
    loopi{1} = [84 47 48 49 50 51 52 53 54 55 5 4 3 2 1 84]
    loopi{2} = [84 56 57 58 59 60 7 6 5]
elseif casei == 4
    % case4,  for decrease_reconfig.m
    loop_type = 0;
    deleted_node = [];
    branches_not_in_loop = [7 9 ; 7 10; 7 8; 20 21; 21 23; 21 22; 23 24];
else
    error
end

% must_on = [6 8 9 10 25];

%% Dados do Sistema de 84 barras
% System data of 84 bars

% Dados globais
% Global data
nref  = 84;         % n?de referência
vref  = 1.0;        % tensão na subestação (pu)
vbase = 11.40;      % Tensão base (kV)
sbase = 10000;      % Potência base (kVA)
tol   = 10^-8;      % Tolerância do erro permitida
vmin  = 0.95;       % Tensão mínima (pu)
vmax  = 1.00;       % Tensão máxima (pu)

% Base de impedância
% Basis of impedance
zbase = 1000*((vbase^2)/sbase);

% Dados de ramos
% Branch data
%         de    para       R(ohm)   X(ohm)
%       from     to          R(ohm)          X(ohm)
Branch= [  1      84       0.1944   0.6624
           1       2       0.2096   0.4304
           2       3       0.2358   0.4842
           3       4       0.0917   0.1883
           4       5       0.2096   0.4304
           5       6       0.0393   0.0807
           6       7       0.0405   0.1380
           7       8       0.1048   0.2152
           7       9       0.2358   0.4842
           7      10       0.1048   0.2152
          11      84       0.0786   0.1614
          11      12       0.3406   0.6944
          12      13       0.0262   0.0538
          12      14       0.0786   0.1614
          15      84       0.1134   0.3864
          15      16       0.0524   0.1076
          16      17       0.0524   0.1076
          17      18       0.1572   0.3228
          18      19       0.0393   0.0807
          19      20       0.1703   0.3497
          20      21       0.2358   0.4842
          21      22       0.1572   0.3228
          21      23       0.1965   0.4035
          23      24       0.1310   0.2690
          25      84       0.0567   0.1932
          25      26       0.1048   0.2152
          26      27       0.2489   0.5111
          27      28       0.0486   0.1656
          28      29       0.1310   0.2690
          30      84       0.1965   0.3960
          30      31       0.1310   0.2690
          31      32       0.1310   0.2690
          32      33       0.0262   0.0538
          33      34       0.1703   0.3497
          34      35       0.0524   0.1076
          35      36       0.4978   1.0222
          36      37       0.0393   0.0807
          37      38       0.0393   0.0807
          38      39       0.0786   0.1614
          39      40       0.2096   0.4304
          38      41       0.1965   0.4035
          41      42       0.2096   0.4304
          43      84       0.0486   0.1656
          43      44       0.0393   0.0807
          44      45       0.1310   0.2690
          45      46       0.2358   0.4842
          47      84       0.2430   0.8280
          47      48       0.0655   0.1345
          48      49       0.0655   0.1345
          49      50       0.0393   0.0807
          50      51       0.0786   0.1614
          51      52       0.0393   0.0807
          52      53       0.0786   0.1614
          53      54       0.0524   0.1076
          54      55       0.1310   0.2690
          56      84       0.2268   0.7728
          56      57       0.5371   1.1029
          57      58       0.0524   0.1076
          58      59       0.0405   0.1380
          59      60       0.0393   0.0807
          60      61       0.0262   0.0538
          61      62       0.1048   0.2152
          62      63       0.2358   0.4842
          63      64       0.0243   0.0828
          65      84       0.0486   0.1656
          65      66       0.1703   0.3497
          66      67       0.1215   0.4140
          67      68       0.2187   0.7452
          68      69       0.0486   0.1656
          69      70       0.0729   0.2484
          70      71       0.0567   0.1932
          71      72       0.0262   0.0528
          73      84       0.3240   1.1040
          73      74       0.0324   0.1104
          74      75       0.0567   0.1932
          75      76       0.0486   0.1656
          77      84       0.2511   0.8556
          77      78       0.1296   0.4416
          78      79       0.0486   0.1656
          79      80       0.1310   0.2640
          80      81       0.1310   0.2640
          81      82       0.0917   0.1883
          82      83       0.3144   0.6456
           5      55       0.1310   0.2690
           7      60       0.1310   0.2690
          11      43       0.1310   0.2690
          12      72       0.3406   0.6994
          13      76       0.4585   0.9415
          14      18       0.5371   1.0824
          16      26       0.0917   0.1883
          20      83       0.0786   0.1614
          28      32       0.0524   0.1076
          29      39       0.0786   0.1614
          34      46       0.0262   0.0538
          40      42       0.1965   0.4035
          53      64       0.0393   0.0807 ];

%%
% Demanda de potência ativa e reativa nas barras
% active and reactive power demand at each bus
%             barra          Pd(kW)   Qd(kW) Qbc(kW)
%               bus          Pd(kW)    Qd(kW)   Qbc(kW)
Bus    = [       
                  84            0.0      0.0     0.0 
                  1             0.0      0.0     0.0   
                  2           100.0     50.0     0.0
                  3           300.0    200.0     0.0  
                  4           350.0    250.0     0.0  
                  5           220.0    100.0     0.0  
                  6          1100.0    800.0     0.0  
                  7           400.0    320.0     0.0  
                  8           300.0    200.0     0.0  
                  9           300.0    230.0     0.0  
                  10          300.0    260.0     0.0  
                  11            0.9      0.0     0.0  
                  12         1200.0    800.0     0.0   
                  13          800.0    600.0     0.0
                  14          700.0    500.0     0.0  
                  15            0.0      0.0     0.0  
                  16          300.0    150.0     0.0  
                  17          500.0    350.0     0.0  
                  18          700.0    400.0     0.0  
                  19         1200.0   1000.0     0.0  
                  20          300.0    300.0     0.0  
                  21          400.0    350.0     0.0  
                  22           50.0     20.0     0.0  
                  23           50.0     20.0     0.0  
                  24           50.0     10.0     0.0  
                  25           50.0     30.0     0.0   
                  26          100.0     60.0     0.0
                  27          100.0     70.0     0.0  
                  28         1800.0   1300.0     0.0  
                  29          200.0    120.0     0.0  
                  30            0.0      0.0     0.0  
                  31         1800.0   1600.0     0.0   
                  32          200.0    150.0     0.0
                  33          200.0    100.0     0.0   
                  34          800.0    600.0     0.0
                  35          100.0     60.0     0.0  
                  36          100.0     60.0     0.0
                  37           20.0     10.0     0.0  
                  38           20.0     10.0     0.0
                  39           20.0     10.0     0.0   
                  40           20.0     10.0     0.0  
                  41          200.0    160.0     0.0  
                  42           50.0     30.0     0.0  
                  43            0.0      0.0     0.0  
                  44           30.0     20.0     0.0   
                  45          800.0    700.0     0.0
                  46          200.0    150.0     0.0   
                  47            0.0      0.0     0.0
                  48            0.0      0.0     0.0   
                  49            0.0      0.0     0.0   
                  50          200.0    160.0     0.0    
                  51          800.0    600.0     0.0  
                  52          500.0    300.0     0.0      
                  53          500.0    350.0     0.0  
                  54          500.0    300.0     0.0  
                  55          200.0     80.0     0.0  
                  56            0.0      0.0     0.0  
                  57           30.0     20.0     0.0  
                  58          600.0    420.0     0.0  
                  59            0.0      0.0     0.0  
                  60           20.0     10.0     0.0   
                  61           20.0     10.0     0.0
                  62          200.0    130.0     0.0  
                  63          300.0    240.0     0.0      
                  64          300.0    200.0     0.0   
                  65            0.0      0.0     0.0    
                  66           50.0     30.0     0.0  
                  67            0.0      0.0     0.0      
                  68          400.0    360.0     0.0  
                  69            0.0      0.0     0.0  
                  70            0.0      0.0     0.0
                  71         2000.0   1500.0     0.0  
                  72          200.0    150.0     0.0  
                  73            0.0      0.0     0.0   
                  74            0.0      0.0     0.0
                  75         1200.0    950.0     0.0  
                  76          300.0    180.0     0.0      
                  77            0.0      0.0     0.0   
                  78          400.0    360.0     0.0    
                  79         2000.0   1300.0     0.0  
                  80          200.0    140.0     0.0      
                  81          500.0    360.0     0.0  
                  82          100.0     30.0     0.0  
                  83          400.0    360.0     0.0];
Bus(deleted_node, :) = [];
for i = 1:length(deleted_node)
    idx = find(Branch(:,1) == deleted_node(i));
    Branch(idx,:) = [];
    idx = find(Branch(:,2) == deleted_node(i));
    Branch(idx,:) = [];
end
% Bus
% Branch

%%  find the # of branch in a loop
if loop_type == 1
    idx = [];
    for loopidx = 1:length(loopi)
        for i = 1:(length(loopi{loopidx})-1)
            idx_brch0 = find_branch(Branch, loopi{loopidx}(i), loopi{loopidx}(i+1));
            if idx_brch0
                idx = [idx; idx_brch0];
            else
                fprintf('error at line 268 of d84_v2.m')
                error
            end
        end
    end
    brch_idx_in_loop = unique(idx);
elseif loop_type == 0    
    idx_not_in_loop = [];
    for i = 1:size(branches_not_in_loop, 1)     
        idx_brch0 = find_branch(Branch, branches_not_in_loop(i,1), ...
            branches_not_in_loop(i,2)); 
        if idx_brch0
            idx_not_in_loop = [idx_not_in_loop; idx_brch0];  
        else
            fprintf('error at line 268 of d84_v2.m')
            error
        end
    end  
    idx_all = [1:size(Branch,1)];
    brch_idx_in_loop = idx_all;
    brch_idx_in_loop(idx_not_in_loop) = [];
else
    fprintf('error at line 289 of d84_v2.m')
    error
end

